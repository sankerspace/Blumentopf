<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HomeWatering Dashboard</title>
  
  <script src="https://cdn.jsdelivr.net/particle-api-js/5.2.6/particle.min.js"></script>
  <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>-->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
</head>

<style type="text/css">
 #outputtext {
   overflow-x:hidden;
   height: 60em;
   bottom: 17px;
   width:100%;
   color:yellow;
   background-color:#38BC55;
  }
  #infoarea {
   overflow-x:hidden;
   height: 10em;
   width:100%;
  
   background-color:#B6CFFC;
  }

  
</style>




<body>


<div id="div_login">

 <form>
  User name:<br>
  <input type="text" name="username" id="user"><br>
  User password:<br>
  <input type="password" name="psw" id="pass">
  <input type="button" onclick="login()" value="Request Token">
  <!-- <input type="submit" onclick="login()" value="Submit"> -->
</form>
<p>You can Login and get a new token automatically or you insert your own Token without Login</p>
<form>
  Token:<br>
  <input type="text" name="TOKEN" id="form_token"><br>
  <input type="button" onclick="login2()" value="Start Dashboard">
  <!-- <input type="submit" onclick="login()" value="Submit"> -->
</form>
</div>





<div id="div_main" style="display:none;">
  <!------------------------------------------------------>
   <!--PUMP CONTROL -->
  <div> 
    <!--Bernhard-->
	<select name="Node Selection" size="1" id="Select_Pump_List">
	</select>
	<input type="text" id="pump_duration1" placeholder="Duration Pump 1.">
	<input type="text" id="pump_duration2" placeholder="Duration Pump 2.">
	<input type="button" onclick="pump()" value="Start Pumping">
	<!--Bernhard-->   
   </div>
   <!------------------------------------------------------>
   <!--INFORMATION AREA -->
   <div>
      <span> <select name="Node Selection" id="Select_Sensor_List" size="1"></select></span>
      <span></span>
      <span><input type="button" name="Load" value="Load Nodes" size="1" onclick="loadNodeList()"></input></span>
   </div>
   <!------------------------------------------------------>
   <div> 
   <textarea name="infoarea" label="Info Output" form="" rows="2" cols="160" placeholder="Particle Photon Cloud Function Output shown here" readonly="true" id="infoarea">
   </textarea>
   </div>  

   <div>
   <textarea name="outputtext" label="Events" form=""  rows="4" cols="160" placeholder="Particle Photon Events shown here" autofocus="true" readonly="true" id="outputtext" ></textarea>
   </div>
</div>











<script type="text/javascript">
//3c9c8f504c6d5695b8367cdcf387be1bee50782c 
 
var timeoptions = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' };

 var particle = new Particle();
 var token_ = 0;
 var device = 0;
 var nodeList=[];
/*
$('textarea').each(function () {
  this.setAttribute('style', 'height:' + (this.scrollHeight) + 'px;overflow-y:hidden;');
}).on('input', function () {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});
 */
 
function loadNodeList() {
   particle.getVariable({ deviceId: device.toString(), name: 'NODELIST', auth: token_ }).then(function(data) {
      console.log('Device variable retrieved successfully:', data);
      var str=data.body.result.split(',');
     
      for(i=0;i<str.length;i++)
      {
           var el = str[i].split(':');
           nodeList[i]=[el[0],el[1]];
           document.getElementById("infoarea").innerHTML+= nodeList[i][0] + " " + nodeList[i][1] + "\n";
      }
      
      var sel_1 = document.getElementById('Select_Sensor_List');
      var sel_2 = document.getElementById('Select_Pump_List');
      sel_1.innerHTML = "";
      sel_2.innerHTML = "";
      for(i=0;i<nodeList.length;i++)
      {
         if(nodeList[i][1].localeCompare("SENSOR")==0)
         {
            sel_1.innerHTML += "<option>"+nodeList[i][0] + "</option>";
         }
         else
         {
            sel_2.innerHTML += "<option>"+nodeList[i][0] + "</option>";
         }
          
      }
   }, 
   function(err) {
      console.log('An error occurred while getting attrs:', err);
   });
}

function login()
{  
   
   var username;
   var password;
   document.getElementById("div_main").style.visibility="visible";
   document.getElementById("div_main").style.display="block";
   document.getElementById("div_login").style.visibility="hidden";
   document.getElementById("div_login").style.display="none";
   username=document.getElementById("user").value;
   password=document.getElementById("pass").value;
   //alert(username + " " + password);
   particle.login({username: username,password: password}).then(
     function(data){
       console.log('API call completed on promise resolve: ', data.body.access_token);
      token_ = data.body.access_token;
      device = data.body.id;
      console.log('token data: ', token_);
      console.log('device data: ', device); 
      showDevices();  
      //resolve();
      
      //Registrate for Particle Events
      particle.getEventStream({ deviceId: 'mine', auth: token_ }).then(function(stream) {
                  stream.on('event', function(data) {
                     console.log("Event: " + data);
                     document.getElementById("outputtext").innerHTML +=JSON.stringify(data.data) + "\n";
                        //JSON.stringify(new Date(data.published_at).toLocaleString('en-US', timeoptions)) +
                        //"   " + JSON.stringify(data.data) + "\n";
                  });
      });      
      
      
     },
     function (err) {
      console.log('Particle Login failed: ', err);
     }
   )   

   //setTimeout(resolve,2000); 
}


function login2()
{
  document.getElementById("div_main").style.visibility="visible";
  document.getElementById("div_main").style.display="block";
  document.getElementById("div_login").style.visibility="hidden";
  document.getElementById("div_login").style.display="none";
  token_= document.getElementById("form_token").value;
  token_ = "77dc1f0ce4d5abf2fefda017e499ba4332915057";
  console.log('token data: ', token_); 
  showDevices(); 
    //Registrate for Particle Events
  particle.getEventStream({ deviceId: 'mine', auth: token_ }).then(function(stream) {
               stream.on('event', function(data) {
                  console.log("Event: " + data);
                  document.getElementById("outputtext").innerHTML +=JSON.stringify(data.data) + "\n";
                     //JSON.stringify(new Date(data.published_at).toLocaleString('en-US', timeoptions)) +
                     //"   " + JSON.stringify(data.data) + "\n";
               });
   });      
   
}



function showDevices()
{
   var devicesPr = particle.listDevices({ auth: token_ });

   devicesPr.then(
      function(devices){
         console.log('Name: ', devices.body[0].name);
         console.log('ID: ', devices.body[0].id);
         device=devices.body[0].id;
         console.log('Last IP: ', devices.body[0].last_ip_address);
         console.log('lastUse: ', devices.body[0].last_heard);  
      },
      function(err) {
      console.log('List devices call failed: ', err);
      }
   );
}


/*
*  Checks the durations entered in the formula and sends a pump command to the controller if the durations are valid.
*/
function pump()
{

	var p_duration1 = document.getElementById("pump_duration1").value;
	var p_duration2 = document.getElementById("pump_duration2").value;
	var p_nodeId = 6723;	// This is the pump node ID. This should be retrieved from the dropdown list and the data structure.
	var p_state = 0;
	
// checking duration 1 for feasibility
	if (isNumeric(p_duration1) == false)	// duration 1 isn't a number
	{
		if(p_duration1 != "")				// duration 1 isn't empty
		{
			alert("Pump duration 1 invalid!");
			console.log('Pump duration 1 invalid!');
			p_state = 1;					// do not pump!
		}
		else
		{
			p_duration1 = 0;
		}
	}
	else if(p_duration1 > 60)				// this is too long!
	{
		alert("Pump duration 1 is too long!");
		p_state = 1;					// do not pump!
	}
	

// checking duration 2 for feasibility	
	if (isNumeric(p_duration2) == false)	// duration 2 isn't a number
	{
		if(p_duration2 != "")				// duration 2 isn't empty
		{
			alert("Pump duration 2 invalid!");
			console.log('Pump duration 2 invalid!');
			p_state = 1;					// do not pump!
		}
		else
		{
			p_duration2 = 0;
		}
	}
	else if(p_duration2 > 60)				// this is too long!
	{
		alert("Pump duration 2 is too long!");
		p_state = 1;					// do not pump!
	}
	
// no duration is specified?
	if ((p_duration1 == 0) && (p_duration2 == 0))
	{
		alert("There is no pump duration specified!");
		p_state = 1;					// do not pump!
	}
	
	if (p_state == 0)	// all fine! Let's pump!
	{

	var request = String(p_nodeId) + "," + String(p_duration1) + "," + String(p_duration2);
	
// according to Blumentopf.cpp the arguments are: pumpnode ID, duration pump1, duration pump 2
	var fnPr = particle.callFunction({ deviceId: device, name: 'TurnOn', argument: request, auth: token_ });

fnPr.then(
  function(data) {
    console.log('Function called succesfully:', data);
	alert("done");
  }, function(err) {
    console.log('An error occurred:', err);
  });

}
}

function isNumeric(n) {
  return !isNaN(parseFloat(n)) && isFinite(n);
}

</script>

</body>
</html>